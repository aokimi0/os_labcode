# UCore 操作系统实验指导书

## 实验概述

本实验课程基于 RISC-V 架构，旨在帮助学生深入理解操作系统核心概念和实现机制。通过三个实验，学生将逐步掌握：

- 操作系统内核的启动过程
- 物理内存管理算法
- 中断处理和系统调用机制

### 实验目标

1. **掌握操作系统基本概念**：进程、内存、中断、系统调用等核心概念
2. **理解系统架构设计**：学习模块化设计和层次化架构
3. **培养编程技能**：熟练使用 C 语言和 RISC-V 汇编语言
4. **掌握调试技巧**：学会使用 QEMU 和 GDB 进行内核调试

### 实验环境

- **硬件平台**：x86_64 架构主机
- **目标架构**：RISC-V 64 位 (RV64)
- **操作系统**：Ubuntu 20.04.5 LTS
- **编译工具**：riscv64-unknown-elf-gcc
- **模拟器**：QEMU
- **调试工具**：GDB + QEMU 调试模式

## 实验环境配置

### 1. 安装 RISC-V 交叉编译工具链

```bash
# 下载预编译工具链
wget https://static.dev.sifive.com/dev-tools/freedom-tools/v2020.12/riscv64-unknown-elf-toolchain-10.2.0-2020.12.8-x86_64-linux-ubuntu14.tar.gz

# 解压到系统路径
sudo tar -xzf riscv64-unknown-elf-toolchain-10.2.0-2020.12.8-x86_64-linux-ubuntu14.tar.gz -C /opt

# 配置环境变量
echo 'export RISCV=/opt/riscv' >> ~/.bashrc
echo 'export PATH=$RISCV/bin:$PATH' >> ~/.bashrc
source ~/.bashrc

# 验证安装
riscv64-unknown-elf-gcc -v
```

### 2. 安装 QEMU 模拟器

```bash
sudo apt update
sudo apt install qemu-system-riscv64

# 安装依赖库（解决glib编译问题）
sudo apt install libglib2.0-dev libpixman-1-dev

# 验证安装
qemu-system-riscv64 --version
```

### 3. 验证环境完整性

```bash
# 测试OpenSBI固件
qemu-system-riscv64 -machine virt -nographic -bios default
```

如果看到 OpenSBI 启动信息，说明环境配置成功。

## Lab1: 内核启动基础

### 实验目的

1. 理解计算机系统启动过程
2. 掌握 RISC-V 架构的基本概念
3. 学会交叉编译和系统模拟

### 实验内容

#### 练习 1：环境搭建和内核编译

1. **编译内核**

   ```bash
   cd lab1
   make
   ```

2. **运行内核**

   ```bash
   make qemu
   ```

3. **观察输出**
   期望看到：`(THU.CST) os is loading ...`

#### 练习 2：理解启动流程

阅读并理解以下关键文件：

- `kern/init/entry.S`：内核入口点
- `kern/init/init.c`：内核初始化
- `tools/kernel.ld`：链接脚本

### 实验要求

1. 成功编译并运行内核
2. 理解启动过程中的各个阶段
3. 记录实验过程和遇到的问题

## Lab2: 物理内存管理

### 实验目的

1. 理解物理内存管理的基本概念
2. 掌握连续内存分配算法
3. 学会内存管理数据结构的实现

### 实验内容

#### 练习 1：理解 First-Fit 算法（思考题）

阅读`kern/mm/default_pmm.c`，理解以下函数：

- `default_init`
- `default_init_memmap`
- `default_alloc_pages`
- `default_free_pages`

**回答问题**：

- First-Fit 算法是否有改进空间？

#### 练习 2：实现 Best-Fit 算法（编程题）

参考`kern/mm/default_pmm.c`，实现`kern/mm/best_fit_pmm.c`中的相应函数。

**回答问题**：

- 你的 Best-Fit 算法是否有改进空间？

#### 扩展练习：伙伴系统（Buddy System）

参考伙伴分配器实现，实现完整的伙伴系统分配算法。

### 实验要求

1. 理解并回答思考题
2. 实现 Best-Fit 算法，通过测试
3. （可选）实现伙伴系统算法

## Lab3: 中断处理

### 实验目的

1. 理解中断和异常机制
2. 掌握中断处理流程
3. 学会系统调用实现

### 实验内容

#### 练习 1：中断初始化

理解`kern/trap/trap.c`中的`idt_init`函数，掌握：

- 中断向量表的建立
- 中断处理函数的注册
- CPU 中断控制

#### 练习 2：异常处理

分析异常处理流程：

- 理解`__alltraps`和`__trapret`
- 掌握异常栈帧结构
- 学会异常分类处理

#### 练习 3：时钟中断

理解时钟中断处理：

- 分析`kern/driver/clock.c`
- 掌握定时器编程
- 理解中断频率控制

### 实验要求

1. 理解中断处理机制
2. 掌握异常处理流程
3. 学会时钟中断编程

## 实验报告要求

### 报告格式

基于 Markdown 格式，包含以下内容：

1. **实验基本信息**

   - 实验名称和编号
   - 完成人姓名和学号
   - 完成日期

2. **实验目的**

   - 简要描述实验目标

3. **实验环境**

   - 硬件和软件配置
   - 环境搭建过程

4. **实验过程**

   - 详细的操作步骤
   - 关键代码分析
   - 遇到的问题及解决方案

5. **实验结果**

   - 运行截图或输出
   - 测试结果分析

6. **实验心得**
   - 学习收获
   - 技术难点分析
   - 改进建议

### 报告提交

- 每个实验单独提交报告
- 格式：`labX_report_姓名.md`
- 提交至指定平台或老师邮箱

## 评分标准

- **实验完成度**（50%）：代码正确性、功能完整性
- **实验报告**（30%）：内容完整性、分析深度
- **创新扩展**（20%）：可选挑战练习的完成情况

## 实验资源汇总

### 在线资源

- **实验指导书**：参考清华大学操作系统实验在线文档
- **RISC-V 手册**：https://riscv.org/technical/specifications/
- **QEMU 文档**：https://www.qemu.org/docs/

### 开发工具

- **SiFive Freedom Tools**：RISC-V 交叉编译工具链
- **QEMU**：系统仿真器
- **GDB**：调试工具

### 参考资料

- 《操作系统概念》（Operating System Concepts）
- 《计算机组成与设计：硬件/软件接口》（RISC-V 版）
- 《深入理解计算机系统》（CSAPP）

### 技术支持

- 操作系统课程讨论群
- 教学助手邮箱
- 在线答疑平台

## 注意事项

1. **代码规范**：遵循良好的编程习惯，添加必要注释
2. **版本控制**：建议使用 Git 管理代码版本
3. **备份数据**：定期备份实验代码和报告
4. **学术诚信**：独立完成实验，遵守学术道德规范
5. **安全注意**：注意代码安全，避免缓冲区溢出等漏洞

## 常见问题

### Q: 编译时出现"riscv64-unknown-elf-gcc: command not found"

A: 检查工具链安装和 PATH 环境变量配置

### Q: QEMU 运行时出现图形界面问题

A: 使用`-nographic`参数运行在终端模式

### Q: GDB 调试连接不上

A: 确保 QEMU 使用`-s -S`参数启动，并正确配置远程连接

---

_实验指导书最后更新：2025 年 10 月_

_参考来源：清华大学计算机系操作系统实验课程_
